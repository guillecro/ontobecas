<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ontobecas - Becados</title>
        <link rel="stylesheet" href="../public/assets/css/app.css" />
        <script src="../bower_components/modernizr/modernizr.js"></script>
    </head>
    <body>

        <div class="row">
            <div class="small-9 small-centered columns">&nbsp;</div>
        </div>
        <div class="row">
            <div class="small-9 small-centered columns panel callout radius">
                <h5>Listado de becados</h5>
                <table width="100%">
                    <thead><tr>
                        <th>LU</th>
                        <th>Nombre</th>
                        <th>PTD</th>
                        <th>PDA</th>
                        <th>PIF</th>
                        <th>PCL</th>
                        <th>PP</th>
                        <th>PRA</th>
                        <th>PCS</th>
                        <th>PSV</th>
                        <th>Total</th>
                    </tr></thead>
                    <tbody>
                        <tr>
                            <td>20001</td>
                            <td>Pablito</td>
                            <td>5</td>
                            <th>4</th>
                            <td>5</td>
                            <th>4</th>
                            <td>5</td>
                            <th>4</th>
                            <td>5</td>
                            <th>4</th>
                            <td>30</td>
                        </tr>
                        <tr>
                            <td>20002</td>
                            <td>Lala</td>
                            <td>5</td>
                            <th>4</th>
                            <td>5</td>
                            <th>4</th>
                            <td>5</td>
                            <th>4</th>
                            <td>5</td>
                            <th>4</th>
                            <td>30</td>
                        </tr>
                    </tbody>
                </table>
                <h5>Alumnos no becados</h5>
                <table width="100%">
                    <thead><tr>
                        <th>LU</th>
                        <th>Nombre</th>
                        <th>Situaci√≥n</th>
                        <th>Puntaje</th>
                    </tr></thead>
                    <tbody>
                        <tr>
                            <td>20003</td>
                            <td>Juanito</td>
                            <td>Rechazado</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>20004</td>
                            <td>Lola</td>
                            <td>Bajo puntaje</td>
                            <td>12</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="small-9 small-centered columns"><a href="base.html" class="button expand">Volver</a></div>
        </div>

        <script src="../public/assets/js/lodash.js"></script>
        <script src="../public/assets/js/stardog.js"></script>
        <script src="../public/assets/js/jquery.min.js"></script>
        <script src="../public/assets/js/foundation.min.js"></script>
        <script src="../public/assets/js/app.js"></script>

        <script type="text/javascript">
            var anioActual = 2015;

            $(document).ready(function() {
                var querySPARQL = "SELECT ?anio WHERE { {?x a onto:CicloLectivoActual} {?x onto:AnioLectivo ?anio} }";
                ejecutarQuery(querySPARQL, obtenerAnio);
            });

            function obtenerAnio(datos) {
                var resultado = datos.results.bindings;
                if (resultado.length > 0) {
                    anioActual = resultado[0].anio.value;
                }
                borrarDependientes();
            }

            function borrarDependientes() {
                ejecutarQuery(genQueryDelete('ACHijosDependientes'), calcularDependientes);
            }
            function calcularDependientes(datos) {
                var querySPARQL = 'SELECT ?x (COUNT(DISTINCT(?hijo)) AS ?y) WHERE { {?x a onto:Alumno} ' +
                    '{?hijo a onto:FamiliarDependiente} {?x onto:ViveCon ?hijo} {?hijo onto:Parentesco "Hijo"} } GROUP BY ?x';
                ejecutarQuery(querySPARQL, cargarDependientes);
            }
            function cargarDependientes(datos) {
                ejecutarQuery(genQueryInsert(datos.results.bindings, 'ACHijosDependientes'), borrarFamiliares);
            }

            function borrarFamiliares() {
                ejecutarQuery(genQueryDelete('ACFamiliaresActivos'), calcularFamiliares);
            }
            function calcularFamiliares(datos) {
                var querySPARQL = "SELECT ?x (COUNT(DISTINCT(?familiar)) AS ?y) WHERE { {?x a onto:Alumno} " +
                    "{?familiar a onto:FamiliarMayor} {?x onto:ViveCon ?familiar} } GROUP BY ?x";
                ejecutarQuery(querySPARQL, cargarFamiliares);
            }
            function cargarFamiliares(datos) {
                ejecutarQuery(genQueryInsert(datos.results.bindings, 'ACFamiliaresActivos'), borrarLaboral);
            }

            function borrarLaboral() {
                ejecutarQuery(genQueryDelete('ACSumaCLValor'), calcularLaboral);
            }
            function calcularLaboral(datos) {
                var querySPARQL = "SELECT ?x (SUM(?clValor) AS ?y) WHERE { {?x a onto:Alumno} {?familiar a onto:FamiliarMayor} " +
                    "{?x onto:ViveCon ?familiar} {?familiar onto:CondicionLaboralValor ?clValor} } GROUP BY ?x";
                ejecutarQuery(querySPARQL, cargarLaboral);
            }
            function cargarLaboral(datos) {
                ejecutarQuery(genQueryInsert(datos.results.bindings, 'ACSumaCLValor'), borrarIngresos);
            }

            function borrarIngresos() {
                ejecutarQuery(genQueryDelete('ACIngresosFamilia'), calcularIngresos);
            }
            function calcularIngresos(datos) {
                var querySPARQL = "SELECT ?x (SUM(?sueldo) AS ?y) WHERE { {?x a onto:Alumno} {?familiar a onto:FamiliarMayor} " +
                    "{?x onto:ViveCon ?familiar} {?familiar onto:IngresoMensual ?sueldo} } GROUP BY ?x";
                ejecutarQuery(querySPARQL, cargarIngresos);
            }
            function cargarIngresos(datos) {
                ejecutarQuery(genQueryInsert(datos.results.bindings, 'ACIngresosFamilia'), borrarPromedios);
            }

            function borrarPromedios() {
                ejecutarQuery(genQueryDelete('ACPromedio'), calcularPromedios);
            }
            function calcularPromedios(datos) {
                var querySPARQL = "SELECT ?x (AVG(?nota) AS ?y) WHERE { {?x a onto:Alumno} {?examen a onto:Examen} " +
                    "{?x onto:Rindio ?examen} {?examen onto:Calificacion ?nota} } GROUP BY ?x";
                ejecutarQuery(querySPARQL, cargarPromedios);
            }
            function cargarPromedios(datos) {
                ejecutarQuery(genQueryInsert(datos.results.bindings, 'ACPromedio'), borrarAprobadas);
            }

            function borrarAprobadas() {
                ejecutarQuery(genQueryDelete('ACMateriasAprobadas'), calcularAprobadas);
            }
            function calcularAprobadas(datos) {
                var querySPARQL = "SELECT ?x (COUNT(DISTINCT(?materia)) AS ?y) WHERE { {?x a onto:Alumno} " +
                    "{?materia a onto:Materia} {?x onto:TieneAprobada ?materia} } GROUP BY ?x";
                ejecutarQuery(querySPARQL, cargarAprobadas);
            }
            function cargarAprobadas(datos) {
                ejecutarQuery(genQueryInsert(datos.results.bindings, 'ACMateriasAprobadas'), borrarRegulares);
            }

            function borrarRegulares() {
                ejecutarQuery(genQueryDelete('ACMateriasRegulares'), calcularRegulares);
            }
            function calcularRegulares(datos) {
                var querySPARQL = "SELECT ?x (COUNT(DISTINCT(?materia)) AS ?y) WHERE { {?x a onto:Alumno} " +
                    "{?materia a onto:Materia} {?x onto:TieneRegularizada ?materia} } GROUP BY ?x";
                ejecutarQuery(querySPARQL, cargarRegulares);
            }
            function cargarRegulares(datos) {
                ejecutarQuery(genQueryInsert(datos.results.bindings, 'ACMateriasRegulares'), borrarAprobRecien);
            }

            "WHERE { {?x a onto:Alumno} {?x onto:NombreCompleto ?nombre} {?x onto:LU ?lu}" +
                    "{?materia a onto:Materia} {?x onto:TieneAprobada ?materia} }" +
                    "{?examen a onto:Examen} {?x onto:Rindio ?examen} {?examen onto:ReferidoA ?materia}" +
                    "{?examen onto:FechaRendida "+ (valorDeSubQuery-1) +"} }" +

            function borrarAprobRecien() {
                ejecutarQuery(genQueryDelete('ACMateriasAprobadasCicloAnterior'), calcularAprobRecien);
            }
            function calcularAprobRecien(datos) {
                var querySPARQL = "SELECT ?x (COUNT(DISTINCT(?materia)) AS ?y) WHERE { {?x a onto:Alumno} " +
                    "{?materia a onto:Materia} {?x onto:TieneAprobada ?materia} {?examen a onto:Examen} " +
                    "{?x onto:Rindio ?examen} {?examen onto:ReferidoA ?materia} } " +
                    "{?examen onto:FechaRendida "+ (anioActual-1) +"} GROUP BY ?x";
                ejecutarQuery(querySPARQL, cargarAprobRecien);
            }
            function cargarAprobRecien(datos) {
                ejecutarQuery(genQueryInsert(datos.results.bindings, 'ACMateriasAprobadasCicloAnterior'), terminarCalculos);
            }

            function genQueryDelete(attributo) {
                return = 'DELETE { ?x onto:' + attributo + ' ?y } WHERE { ?x onto:' + attributo + ' ?y }';
            }
            function genQueryInsert(resultado, attributo) {
                var query = 'INSERT DATA { ';
                for(i in resultado) {
                    query += '<' + resultado[i].x.value + '> onto:' + attributo + ' ' + resultado[i].y.value + '. ';
                }
                query += '}';
                return query;
            }

            function terminarCalculos() {
                alert('holis');
            }
        </script>
    </body>
</html>
